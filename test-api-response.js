// Test script to verify JSON parsing works with your exact response
const rawJsonResponse = `{"executiveSummary": {"overallHealth": "Moderate","creditGrade": "C","gradeExplanation": "The credit grade of C is assigned due to a combination of declining working capital, a current ratio below the target of 1.5:1, and a debt coverage ratio (DCR) that, while above 1.25:1, shows volatility. The net income has fluctuated significantly over the past years, indicating operational challenges. The overall leverage is concerning, with a high debt-to-equity ratio.","standardPrinciples": "The analysis adheres to GAAP principles and agricultural lending standards, focusing on cash flow adequacy, asset quality, and operational efficiency.","keyStrengths": ["Positive net income trends in recent years","DCR above the minimum requirement","Diverse income sources including nonfarm income"],"criticalWeaknesses": ["Current ratio below target","Declining working capital","High levels of accrued interest and liabilities"],"riskLevel": "Medium","creditRecommendation": "Conditional"},"sections": [{"title": "Earnings","summary": "Comprehensive analysis of farm income performance, profitability trends, and operational efficiency","narrative": "Gross Farm Income has shown an upward trend, increasing from $1,444,924 in 2021 to $1,929,596 in 2023, reflecting a growth of 33.5%. However, Net Farm Income has fluctuated, with a peak of $414,228 in 2021 and a decline to $326,850 in 2023. The Net Nonfarm Income has remained stable, averaging around $160,000, providing a cushion against farm income volatility. The Margin After Servicing has decreased, indicating increased operational costs. The Term Interest and Principal Demand burden is significant, with total term interest payments of $220,874 in 2023, impacting net income. The DCR has been above the 1.25:1 threshold, averaging 1.47:1 over the past three years, but shows signs of instability.","metrics": [{"name": "Gross Farm Income","value": "$1,929,596 (2023), up 33.5% from $1,444,924 (2021)","trend": "Improving","analysis": "The increase in Gross Farm Income is attributed to higher crop yields and favorable market prices."},{"name": "Net Farm Income","value": "$326,850 (2023), down from $414,228 (2021)","trend": "Declining","analysis": "Net Farm Income has decreased due to rising operational costs, particularly in feed and fertilizer."},{"name": "Earned Equity DCR (3-year avg)","value": "1.47:1, with a margin after servicing of $75,086","trend": "Stable","analysis": "The DCR remains above the 1.25:1 standard, indicating adequate cash flow to cover debt obligations."}],"keyFindings": ["Gross Farm Income has increased significantly, but Net Farm Income is declining.","DCR is stable but shows volatility, indicating potential cash flow issues."]},{"title": "Cash","summary": "Cash flow analysis, debt service capacity, and liquidity assessment", "narrative": "The 3-year average Cash DCR is 1.47:1, indicating a reasonable capacity to service debt. However, projected cash flow shows potential declines due to rising costs. The Operating Expense Ratio is at 75%, which is at the upper limit of the target range, suggesting that operational efficiency needs improvement. Family living expenses are adequately covered, but the working capital position is concerning, with a negative working capital of -$413,774 in 2023, which could impact liquidity.","metrics": [{"name": "Cash DCR (3-year avg)","value": "1.47:1, with a margin after servicing of $75,086","trend": "Stable","analysis": "The average DCR indicates sufficient cash flow to meet debt obligations, but future projections are uncertain."},{"name": "Projected Cash DCR","value": "1.30:1 projected for 2024","trend": "Declining","analysis": "Projected cash flow is expected to decline due to increased operational costs."},{"name": "Operating Expense Ratio","value": "75%","trend": "Stable","analysis": "The ratio is at the upper limit of the target range, indicating potential inefficiencies in managing operational costs."}],"keyFindings": ["Cash flow is adequate but projected to decline.","High operating expense ratio indicates potential inefficiencies."]},{"title": "Capital","summary": "Working capital position, asset composition, debt structure, and equity analysis","narrative": "Working capital has declined significantly, with a negative position of -$413,774 in 2023, indicating liquidity challenges. The Current Ratio is 0.75:1, below the target of 1.5:1, highlighting a gap of $1,167,774 needed to meet the standard. The Owner's Equity Ratio is 56.1%, which is acceptable but indicates high leverage. Total Non-Current Assets are valued at $11,788,269, providing a solid asset base, but the debt structure shows reliance on FCSAmerica loans, which could pose risks if market conditions change.","metrics": [{"name": "Working Capital","value": "-$413,774, declining from $345,692 in 2022","trend": "Declining","analysis": "Negative working capital indicates liquidity issues that could affect operational capabilities."},{"name": "Current Ratio","value": "0.75:1, below the target of 1.5:1","trend": "Declining","analysis": "The current ratio indicates a liquidity gap of $1,167,774 needed to meet the standard."},{"name": "Owner's Equity Ratio","value": "56.1%","trend": "Stable","analysis": "The equity position is acceptable, but high leverage poses risks."},{"name": "Net Worth","value": "$7,322,814, with total assets of $13,054,013","trend": "Improving","analysis": "Total assets have increased, but liabilities are also rising, indicating a need for careful management."}],"keyFindings": ["Negative working capital poses liquidity risks.","Current ratio is significantly below target, indicating potential operational challenges."]},{"title": "5 C's of Credit Assessment","summary": "Comprehensive credit evaluation using the 5 C's framework","creditFactors": [{"factor": "Character","assessment": "Management has demonstrated operational competence but faces challenges in maintaining profitability.","score": "Adequate","supportingEvidence": "Management's ability to navigate fluctuating income levels shows resilience."},{"factor": "Capacity","assessment": "Cash flow analysis indicates adequate capacity to service debt, but projections show potential declines.","score": "Adequate","supportingEvidence": "DCR above 1.25:1 indicates capacity, but volatility in cash flow is a concern."},{"factor": "Capital","assessment": "Equity position is acceptable, but high leverage and declining working capital are concerning.","score": "Adequate","supportingEvidence": "Owner's equity ratio of 56.1% is acceptable, but working capital is negative."},{"factor": "Collateral","assessment": "Asset quality is strong, with significant real estate and equipment values.","score": "Strong","supportingEvidence": "Total assets valued at $13,054,013 provide a solid collateral base."},{"factor": "Conditions","assessment": "Market conditions are stable, but commodity price volatility poses risks.","score": "Neutral","supportingEvidence": "Current economic indicators show stability, but agricultural markets are subject to fluctuations."}],"keyFindings": ["Overall credit assessment indicates adequate management and operational capacity, but liquidity and profitability challenges remain."]},{"title": "Lending Standards Compliance","summary": "Evaluation against agricultural lending benchmarks and regulatory standards","complianceMetrics": [{"standard": "Current Ratio (1.5:1 target)","currentValue": "0.75:1","compliance": "Below","gapAnalysis": "$1,167,774 needed to meet standard"},{"standard": "Debt Coverage Ratio (1.25:1 minimum)","currentValue": "1.47:1","compliance": "Meets","gapAnalysis": "Above standard by $0.22"},{"standard": "Operating Expense Ratio (65-75% target)","currentValue": "75%","compliance": "Meets","gapAnalysis": "At upper limit of target range"}],"keyFindings": ["Compliance with DCR and operating expense ratio, but current ratio is significantly below target."]},{"title": "Credit Recommendations","summary": "Comprehensive lending recommendations based on integrated analysis",  "recommendations": [{"category": "Liquidity Management","recommendation": "Implement strategies to improve working capital and liquidity.","priority": "High","rationale": "Negative working capital poses significant risks to operational capabilities.","timeline": "Immediate"},{"category": "Cost Management","recommendation": "Review and optimize operational expenses to improve profitability.","priority": "Medium","rationale": "High operating expense ratio indicates inefficiencies that need to be addressed.","timeline": "Next fiscal year"},{"category": "Debt Restructuring","recommendation": "Consider restructuring existing debt to improve cash flow.","priority": "Medium","rationale": "High levels of accrued interest and liabilities could impact future cash flow.","timeline": "Next 6 months"}],"monitoringRequirements": [{"metric": "Working Capital","frequency": "Quarterly","threshold": "$0","action": "Review operational strategies if working capital remains negative."},{"metric": "Current Ratio","frequency": "Quarterly","threshold": "1.5:1","action": "Implement liquidity improvement strategies if below threshold."}],"keyFindings": ["Immediate attention is required to address liquidity challenges and improve operational efficiency."]}]}`;

console.log('Testing JSON parsing...');
console.log('Raw response length:', rawJsonResponse.length);

try {
    const parsed = JSON.parse(rawJsonResponse);
    console.log('✅ JSON parsing successful!');
    console.log('Has executiveSummary:', !!parsed.executiveSummary);
    console.log('Has sections:', !!parsed.sections);
    console.log('Sections count:', parsed.sections?.length);
    console.log('Section titles:', parsed.sections?.map(s => s.title));
    
    // Test specific fields
    console.log('Credit Grade:', parsed.executiveSummary.creditGrade);
    console.log('Risk Level:', parsed.executiveSummary.riskLevel);
    console.log('Key Strengths:', parsed.executiveSummary.keyStrengths);
    
    // Test sections
    parsed.sections.forEach((section, index) => {
        console.log(`Section ${index + 1}: ${section.title}`);
        if (section.creditFactors) {
            console.log('  - Has creditFactors:', section.creditFactors.length);
        }
        if (section.complianceMetrics) {
            console.log('  - Has complianceMetrics:', section.complianceMetrics.length);
        }
        if (section.recommendations) {
            console.log('  - Has recommendations:', section.recommendations.length);
        }
        if (section.metrics) {
            console.log('  - Has metrics:', section.metrics.length);
        }
    });
    
} catch (error) {
    console.error('❌ JSON parsing failed:', error);
    console.error('Error at position:', error.message);
}
